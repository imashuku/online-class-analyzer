<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æˆæ¥­å‚åŠ çŠ¶æ³åˆ†æãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            border-radius: 15px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .upload-section {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #4f46e5;
            background: #f1f5f9;
        }

        .upload-button {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
        }

        .settings-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
        }

        .setting-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .setting-item input, .setting-item select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .setting-item input:focus, .setting-item select:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .analyze-button {
            background: linear-gradient(45deg, #059669, #10b981);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.2em;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }

        .analyze-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
        }

        .analyze-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4f46e5;
        }

        .result-card h3 {
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: linear-gradient(45deg, #f3f4f6, #e5e7eb);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4f46e5;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
        }

        .student-item {
            padding: 10px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-name {
            font-weight: 600;
            color: #1f2937;
        }

        .student-details {
            font-size: 0.9em;
            color: #6b7280;
        }

        .warning {
            background: #fef2f2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #dc2626;
            margin: 10px 0;
        }

        .success {
            background: #f0fdf4;
            color: #059669;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #059669;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #4f46e5;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .export-button:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4f46e5;
            position: relative;
            width: 100%;
            height: 500px;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 400px !important;
            max-width: 100%;
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æˆæ¥­å‚åŠ çŠ¶æ³åˆ†æãƒ„ãƒ¼ãƒ«</h1>
            <p>Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€å­¦ç”Ÿã®å‚åŠ çŠ¶æ³ã‚’è©³ç´°ã«åˆ†æã—ã¾ã™</p>
        </div>

        <div class="upload-section">
            <h3>ğŸ“ Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
            <p>å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ã®Excelãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.xlsxï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <br>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            <button class="upload-button" onclick="document.getElementById('fileInput').click();">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            </button>
            <div id="fileName" style="margin-top: 15px; color: #6b7280;"></div>
        </div>

        <div class="settings-section">
            <h3>âš™ï¸ åˆ†æè¨­å®š</h3>
            <div class="settings-grid">
                <div class="setting-item">
                    <label>æˆæ¥­é–‹å§‹æ™‚åˆ»</label>
                    <input type="time" id="classStart" value="16:20">
                </div>
                <div class="setting-item">
                    <label>æˆæ¥­çµ‚äº†æ™‚åˆ»</label>
                    <input type="time" id="classEnd" value="17:50">
                </div>
                <div class="setting-item">
                    <label>å‡ºå¸­åŸºæº–æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                    <input type="number" id="attendanceThreshold" value="75" min="1" max="200">
                </div>
                <div class="setting-item">
                    <label>é…åˆ»åˆ¤å®šæ™‚åˆ»ï¼ˆè¦ãƒ•ã‚©ãƒ­ãƒ¼åŸºæº–ï¼‰</label>
                    <input type="time" id="lateThreshold" value="16:35">
                </div>
            </div>
        </div>

        <button class="analyze-button" id="analyzeButton" onclick="analyzeData()" disabled>
            ğŸ” ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã™ã‚‹
        </button>

        <div class="results-section" id="resultsSection" style="display: none;">
            <!-- åˆ†æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <script>
        let uploadedData = null;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠä¸­: ' + file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        
                        uploadedData = data;
                        document.getElementById('analyzeButton').disabled = false;
                        
                        showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', 'success');
                    } catch (error) {
                        showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                    }
                };
                reader.readAsBinaryString(file);
            }
        });

        function normalizeStudentName(name) {
            if (!name || name.includes('åŠ©æ‰‹') || name.includes('ãƒãƒ„ã‚ª') || name.includes('æ£®å²¡')) {
                return null;
            }
            return name.trim();
        }

        function extractStudentId(name) {
            if (!name) return null;
            
            const patterns = [
                /(\d{2}[A-Z]\d{3}-\d)/g,
                /(\d{2}[A-Z]\d{2}-\d)/g,
                /(\d{2}[A-Z]\d{4}-\d)/g
            ];
            
            for (let pattern of patterns) {
                const match = name.match(pattern);
                if (match) {
                    return match[0];
                }
            }
            
            return null;
        }

        function analyzeData() {
            if (!uploadedData) {
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showLoading();

            const classStart = document.getElementById('classStart').value;
            const classEnd = document.getElementById('classEnd').value;
            const attendanceThreshold = parseInt(document.getElementById('attendanceThreshold').value);
            const lateThreshold = document.getElementById('lateThreshold').value;

            const today = new Date().toISOString().split('T')[0];
            const classStartTime = new Date(today + 'T' + classStart + ':00');
            const classEndTime = new Date(today + 'T' + classEnd + ':00');
            const lateThresholdTime = new Date(today + 'T' + lateThreshold + ':00');

            setTimeout(function() {
                try {
                    const participantData = uploadedData.slice(2);
                    const analysis = performAnalysis(participantData, classStartTime, classEndTime, lateThresholdTime, attendanceThreshold);
                    displayResults(analysis);
                } catch (error) {
                    showMessage('åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                    hideLoading();
                }
            }, 500);
        }

        function performAnalysis(participantData, classStart, classEnd, lateThreshold, attendanceThreshold) {
            const studentSessions = {};

            participantData.forEach(function(row) {
                const originalName = row[0];
                const studentId = extractStudentId(originalName);
                const duration = parseInt(row[4]) || 0;
                const joinTime = row[2];
                const email = row[1] || 'ãªã—';

                if (studentId && duration > 0) {
                    if (!studentSessions[studentId]) {
                        studentSessions[studentId] = {
                            sessions: [],
                            totalDuration: 0,
                            email: email,
                            displayName: originalName,
                            allNames: new Set()
                        };
                    }
                    
                    studentSessions[studentId].allNames.add(originalName);
                    
                    if (email && email !== 'ãªã—' && email.trim() !== '') {
                        studentSessions[studentId].email = email;
                    }
                    
                    studentSessions[studentId].sessions.push({ joinTime: joinTime, duration: duration });
                    studentSessions[studentId].totalDuration += duration;
                }
            });

            const studentAnalysis = [];
            Object.entries(studentSessions).forEach(function([studentId, data]) {
                const sortedSessions = data.sessions.sort(function(a, b) {
                    return new Date(a.joinTime) - new Date(b.joinTime);
                });
                const firstJoinTime = new Date(sortedSessions[0].joinTime);
                
                const isUnderThreshold = data.totalDuration < attendanceThreshold;
                const isLateJoiner = firstJoinTime >= lateThreshold;
                const needsFollowUp = isUnderThreshold || isLateJoiner;
                
                studentAnalysis.push({
                    studentId: studentId,
                    displayName: data.displayName,
                    allNames: Array.from(data.allNames),
                    email: data.email,
                    totalDuration: data.totalDuration,
                    sessionCount: data.sessions.length,
                    firstJoinTime: sortedSessions[0].joinTime,
                    firstJoinTimeObj: firstJoinTime,
                    sessions: sortedSessions,
                    meetsThreshold: data.totalDuration >= attendanceThreshold,
                    hasMultipleSessions: data.sessions.length > 1,
                    isLateJoiner: isLateJoiner,
                    isUnderThreshold: isUnderThreshold,
                    needsFollowUp: needsFollowUp
                });
            });

            const totalStudents = studentAnalysis.length;
            const attendingStudents = studentAnalysis.filter(function(s) { return s.meetsThreshold && !s.isLateJoiner; });
            const followUpStudents = studentAnalysis.filter(function(s) { return s.needsFollowUp; });
            const lateJoiners = studentAnalysis.filter(function(s) { return s.isLateJoiner; });
            const underThresholdStudents = studentAnalysis.filter(function(s) { return s.isUnderThreshold; });
            const multipleEntries = studentAnalysis.filter(function(s) { return s.hasMultipleSessions; });

            const timeDistribution = {
                'æˆæ¥­å‰(16:20å‰)': 0,
                'é–‹å§‹ç›´å¾Œ(16:20-16:35)': 0,
                'å‰åŠ(16:35-17:00)': 0,
                'ä¸­ç›¤(17:00-17:30)': 0,
                'å¾ŒåŠ(17:30-17:50)': 0,
                'æˆæ¥­å¾Œ(17:50å¾Œ)': 0
            };

            studentAnalysis.forEach(function(student) {
                const timeStr = student.firstJoinTime;
                let time;
                
                if (timeStr.includes('PM') || timeStr.includes('AM')) {
                    time = new Date(timeStr);
                } else {
                    time = new Date(timeStr);
                }
                
                if (isNaN(time.getTime())) {
                    console.log('Invalid time:', timeStr);
                    return;
                }
                
                const hour = time.getHours();
                const minute = time.getMinutes();
                
                if (hour < 16 || (hour === 16 && minute < 20)) {
                    timeDistribution['æˆæ¥­å‰(16:20å‰)']++;
                } else if (hour === 16 && minute >= 20 && minute < 35) {
                    timeDistribution['é–‹å§‹ç›´å¾Œ(16:20-16:35)']++;
                } else if (hour === 16 && minute >= 35) {
                    timeDistribution['å‰åŠ(16:35-17:00)']++;
                } else if (hour === 17 && minute < 30) {
                    timeDistribution['ä¸­ç›¤(17:00-17:30)']++;
                } else if (hour === 17 && minute >= 30 && minute < 50) {
                    timeDistribution['å¾ŒåŠ(17:30-17:50)']++;
                } else if (hour === 17 && minute >= 50) {
                    timeDistribution['æˆæ¥­å¾Œ(17:50å¾Œ)']++;
                } else if (hour >= 18) {
                    timeDistribution['æˆæ¥­å¾Œ(17:50å¾Œ)']++;
                } else {
                    console.log('Unclassified time:', hour + ':' + minute, timeStr);
                    timeDistribution['ä¸­ç›¤(17:00-17:30)']++;
                }
            });

            const categories = {
                'æ¥µçŸ­æ™‚é–“(1-5åˆ†)': [],
                'çŸ­æ™‚é–“(6-15åˆ†)': [],
                'ä¸­ç¨‹åº¦ä¸è¶³(16-45åˆ†)': [],
                'è‹¥å¹²ä¸è¶³(46-74åˆ†)': [],
                'å‡ºå¸­é”æˆ(75åˆ†ä»¥ä¸Š)': []
            };

            studentAnalysis.forEach(function(student) {
                const duration = student.totalDuration;
                if (duration <= 5) categories['æ¥µçŸ­æ™‚é–“(1-5åˆ†)'].push(student);
                else if (duration <= 15) categories['çŸ­æ™‚é–“(6-15åˆ†)'].push(student);
                else if (duration <= 45) categories['ä¸­ç¨‹åº¦ä¸è¶³(16-45åˆ†)'].push(student);
                else if (duration < attendanceThreshold) categories['è‹¥å¹²ä¸è¶³(46-74åˆ†)'].push(student);
                else categories['å‡ºå¸­é”æˆ(75åˆ†ä»¥ä¸Š)'].push(student);
            });

            const avgDuration = studentAnalysis.reduce(function(sum, s) { return sum + s.totalDuration; }, 0) / totalStudents;

            return {
                totalStudents: totalStudents,
                attendingStudents: attendingStudents.length,
                followUpStudents: followUpStudents.length,
                lateJoiners: lateJoiners.length,
                underThresholdStudents: underThresholdStudents.length,
                multipleEntries: multipleEntries.length,
                avgDuration: Math.round(avgDuration),
                categories: categories,
                timeDistribution: timeDistribution,
                followUpList: followUpStudents.sort(function(a, b) { return a.totalDuration - b.totalDuration; }),
                lateJoinersList: lateJoiners,
                underThresholdList: underThresholdStudents.sort(function(a, b) { return a.totalDuration - b.totalDuration; }),
                allStudents: studentAnalysis
            };
        }

        function displayResults(analysis) {
            const resultsSection = document.getElementById('resultsSection');
            
            let html = '';
            html += '<div class="result-card">';
            html += '<h3>ğŸ“ˆ åˆ†æçµæœã‚µãƒãƒªãƒ¼</h3>';
            html += '<div class="success"><strong>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶:</strong> å­¦ç±ç•ªå·ãŒåå‰ã«å«ã¾ã‚Œã¦ã„ã‚‹å­¦ç”Ÿã®ã¿ã‚’åˆ†æå¯¾è±¡ã¨ã—ã¦ã„ã¾ã™</div>';
            html += '<div class="stats-grid">';
            html += '<div class="stat-item"><div class="stat-value">' + analysis.totalStudents + '</div><div class="stat-label">ç·å­¦ç”Ÿæ•°</div></div>';
            html += '<div class="stat-item"><div class="stat-value">' + analysis.attendingStudents + '</div><div class="stat-label">å‡ºå¸­é”æˆ (' + Math.round(analysis.attendingStudents/analysis.totalStudents*100) + '%)</div></div>';
            html += '<div class="stat-item"><div class="stat-value">' + analysis.followUpStudents + '</div><div class="stat-label">è¦ãƒ•ã‚©ãƒ­ãƒ¼ (' + Math.round(analysis.followUpStudents/analysis.totalStudents*100) + '%)</div></div>';
            html += '<div class="stat-item"><div class="stat-value">' + analysis.avgDuration + 'åˆ†</div><div class="stat-label">å¹³å‡å‚åŠ æ™‚é–“</div></div>';
            html += '<div class="stat-item"><div class="stat-value">' + analysis.multipleEntries + '</div><div class="stat-label">è¤‡æ•°å›å…¥é€€å®¤</div></div>';
            html += '<div class="stat-item"><div class="stat-value">' + analysis.lateJoiners + '</div><div class="stat-label">é…åˆ»å…¥å®¤(16:35ä»¥é™)</div></div>';
            html += '</div></div>';

            html += '<div class="chart-container">';
            html += '<h3>ğŸ“Š åˆå›å…¥å®¤æ™‚åˆ»åˆ†å¸ƒ</h3>';
            html += '<canvas id="timeDistributionChart"></canvas>';
            html += '</div>';

            html += '<div class="result-card">';
            html += '<h3>â° å‚åŠ æ™‚é–“åˆ¥åˆ†å¸ƒ</h3>';
            html += '<div class="stats-grid">';
            Object.entries(analysis.categories).forEach(function([category, students]) {
                html += '<div class="stat-item"><div class="stat-value">' + students.length + '</div><div class="stat-label">' + category + '</div></div>';
            });
            html += '</div></div>';

            html += '<div class="result-card">';
            html += '<h3>âš ï¸ è¦ãƒ•ã‚©ãƒ­ãƒ¼å­¦ç”Ÿï¼ˆ75åˆ†æœªæº€ OR 16:35ä»¥é™åˆå›å…¥å®¤ï¼‰</h3>';
            html += '<div class="warning"><strong>è¦ãƒ•ã‚©ãƒ­ãƒ¼æ¡ä»¶:</strong><br>ãƒ»ã®ã¹åœ¨å®¤æ™‚é–“ãŒ75åˆ†æœªæº€ã®å­¦ç”Ÿ<br>ãƒ»16:35ä»¥é™ã«åˆå›å…¥å®¤ã—ãŸå­¦ç”Ÿï¼ˆæˆæ¥­é–‹å§‹15åˆ†å¾Œï¼‰</div>';
            html += '<div class="student-list">';
            analysis.followUpList.forEach(function(student, index) {
                const reasons = [];
                if (student.isUnderThreshold) reasons.push('æ™‚é–“ä¸è¶³');
                if (student.isLateJoiner) reasons.push('é…åˆ»å…¥å®¤');
                
                html += '<div class="student-item">';
                html += '<div>';
                html += '<div class="student-name">' + (index + 1) + '. ' + student.displayName + ' (' + student.studentId + ')</div>';
                html += '<div class="student-details">';
                html += 'ãƒ¡ãƒ¼ãƒ«: ' + student.email + '<br>';
                html += 'åˆå›å…¥å®¤: ' + student.firstJoinTime + ' | ã®ã¹åœ¨å®¤æ™‚é–“: ' + student.totalDuration + 'åˆ†<br>';
                html += 'è¦ãƒ•ã‚©ãƒ­ãƒ¼ç†ç”±: ' + reasons.join(', ');
                if (student.allNames.length > 1) {
                    html += '<br>ä½¿ç”¨ã—ãŸåå‰: ' + student.allNames.join(', ');
                }
                html += '</div></div></div>';
            });
            html += '</div></div>';

            if (analysis.lateJoiners > 0) {
                html += '<div class="result-card">';
                html += '<h3>ğŸ• 16:35ä»¥é™åˆå›å…¥å®¤å­¦ç”Ÿï¼ˆè©³ç´°ï¼‰</h3>';
                html += '<div class="student-list">';
                analysis.lateJoinersList.forEach(function(student, index) {
                    html += '<div class="student-item">';
                    html += '<div>';
                    html += '<div class="student-name">' + (index + 1) + '. ' + student.displayName + ' (' + student.studentId + ')</div>';
                    html += '<div class="student-details">';
                    html += 'ãƒ¡ãƒ¼ãƒ«: ' + student.email + '<br>';
                    html += 'åˆå›å…¥å®¤: ' + student.firstJoinTime + ' | ã®ã¹åœ¨å®¤æ™‚é–“: ' + student.totalDuration + 'åˆ† (' + student.sessionCount + 'å›å…¥é€€å®¤)';
                    if (student.allNames.length > 1) {
                        html += '<br>ä½¿ç”¨ã—ãŸåå‰: ' + student.allNames.join(', ');
                    }
                    html += '</div></div></div>';
                });
                html += '</div></div>';
            }

            html += '<div class="export-buttons">';
            html += '<button class="export-button" onclick="exportToCSV()">ğŸ“Š CSVå‡ºåŠ›</button>';
            html += '<button class="export-button" onclick="generateReport()">ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>';
            html += '</div>';

            resultsSection.innerHTML = html;
            resultsSection.style.display = 'block';
            
            window.currentAnalysis = analysis;
            
            setTimeout(function() {
                const chartElement = document.getElementById('timeDistributionChart');
                if (chartElement) {
                    createTimeDistributionChart(analysis.timeDistribution);
                } else {
                    console.log('Chart element not found');
                }
            }, 200);
            
            hideLoading();
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function createTimeDistributionChart(timeDistribution) {
            const ctx = document.getElementById('timeDistributionChart');
            if (!ctx) {
                console.log('Canvas element not found');
                return;
            }
            
            if (window.myChart) {
                window.myChart.destroy();
            }
            
            console.log('Chart data:', labels, data);
            
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å­¦ç”Ÿæ•°',
                        data: data,
                        backgroundColor: [
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(107, 114, 128, 0.8)'
                        ],
                        borderColor: [
                            'rgba(245, 158, 11, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(139, 92, 246, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(107, 114, 128, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: 'åˆå›å…¥å®¤æ™‚åˆ»åˆ¥å­¦ç”Ÿæ•°åˆ†å¸ƒï¼ˆæˆæ¥­æ™‚é–“: 16:20-17:50ï¼‰',
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            padding: 20
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'å­¦ç”Ÿæ•°: ' + context.parsed.y + 'å';
                                },
                                afterLabel: function(context) {
                                    const total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                                    const percentage = Math.round((context.parsed.y / total) * 100);
                                    return 'å‰²åˆ: ' + percentage + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return value + 'å';
                                }
                            },
                            title: {
                                display: true,
                                text: 'å­¦ç”Ÿæ•°ï¼ˆåï¼‰',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'å…¥å®¤æ™‚åˆ»å¸¯',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutCubic'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function exportToCSV() {
            if (!window.currentAnalysis) {
                showMessage('åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            const csvContent = generateCSVContent(window.currentAnalysis);
            downloadFile(csvContent, 'attendance_analysis.csv', 'text/csv');
        }

        function generateReport() {
            if (!window.currentAnalysis) {
                showMessage('åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }
            const reportContent = generateReportContent(window.currentAnalysis);
            downloadFile(reportContent, 'attendance_report.txt', 'text/plain');
        }

        function generateCSVContent(analysis) {
            const headers = ['å­¦ç±ç•ªå·', 'è¡¨ç¤ºå', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', 'åˆå›å…¥å®¤æ™‚åˆ»', 'ã®ã¹åœ¨å®¤æ™‚é–“ï¼ˆåˆ†ï¼‰', 'å…¥é€€å®¤å›æ•°', 'è¦ãƒ•ã‚©ãƒ­ãƒ¼ç†ç”±', 'ä½¿ç”¨ã—ãŸå…¨ã¦ã®åå‰'];
            const rows = analysis.followUpList.map(function(student) {
                const reasons = [];
                if (student.isUnderThreshold) reasons.push('æ™‚é–“ä¸è¶³');
                if (student.isLateJoiner) reasons.push('é…åˆ»å…¥å®¤');
                
                return [
                    student.studentId,
                    student.displayName,
                    student.email,
                    student.firstJoinTime,
                    student.totalDuration,
                    student.sessionCount,
                    reasons.join(', '),
                    student.allNames.join(' / ')
                ];
            });

            const csvData = [headers].concat(rows);
            return csvData.map(function(row) {
                return row.join(',');
            }).join('\n');
        }

        function generateReportContent(analysis) {
            const date = new Date().toLocaleDateString('ja-JP');
            let report = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æˆæ¥­å‚åŠ çŠ¶æ³åˆ†æãƒ¬ãƒãƒ¼ãƒˆ\n';
            report += 'ç”Ÿæˆæ—¥æ™‚: ' + date + '\n\n';
            report += 'ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã€‘\n';
            report += 'å­¦ç±ç•ªå·ãŒåå‰ã«å«ã¾ã‚Œã¦ã„ã‚‹å­¦ç”Ÿã®ã¿ã‚’åˆ†æå¯¾è±¡\n\n';
            report += 'ã€æ¦‚è¦ã€‘\n';
            report += 'ç·å­¦ç”Ÿæ•°: ' + analysis.totalStudents + 'å\n';
            report += 'å‡ºå¸­é”æˆ: ' + analysis.attendingStudents + 'å (' + Math.round(analysis.attendingStudents/analysis.totalStudents*100) + '%)\n';
            report += 'è¦ãƒ•ã‚©ãƒ­ãƒ¼: ' + analysis.followUpStudents + 'å (' + Math.round(analysis.followUpStudents/analysis.totalStudents*100) + '%)\n';
            report += 'å¹³å‡å‚åŠ æ™‚é–“: ' + analysis.avgDuration + 'åˆ†\n';
            report += 'è¤‡æ•°å›å…¥é€€å®¤: ' + analysis.multipleEntries + 'å\n';
            report += 'é…åˆ»å…¥å®¤(16:35ä»¥é™): ' + analysis.lateJoiners + 'å\n\n';
            report += 'ã€è¦ãƒ•ã‚©ãƒ­ãƒ¼æ¡ä»¶ã€‘\n';
            report += 'ã®ã¹åœ¨å®¤æ™‚é–“75åˆ†æœªæº€\n';
            report += '16:35ä»¥é™åˆå›å…¥å®¤ï¼ˆæˆæ¥­é–‹å§‹15åˆ†å¾Œï¼‰\n\n';
            
            report += 'ã€å‚åŠ æ™‚é–“åˆ¥åˆ†å¸ƒã€‘\n';
            Object.entries(analysis.categories).forEach(function([category, students]) {
                report += category + ': ' + students.length + 'å\n';
            });
            
            report += '\nã€åˆå›å…¥å®¤æ™‚åˆ»åˆ†å¸ƒã€‘\n';
            Object.entries(analysis.timeDistribution).forEach(function([timeSlot, count]) {
                report += timeSlot + ': ' + count + 'å\n';
            });
            
            report += '\nã€è¦ãƒ•ã‚©ãƒ­ãƒ¼å­¦ç”Ÿä¸€è¦§ã€‘\n';
            if (analysis.followUpList.length === 0) {
                report += 'è©²å½“å­¦ç”Ÿãªã—\n';
            } else {
                analysis.followUpList.forEach(function(student, index) {
                    const reasons = [];
                    if (student.isUnderThreshold) reasons.push('æ™‚é–“ä¸è¶³');
                    if (student.isLateJoiner) reasons.push('é…åˆ»å…¥å®¤');
                    report += (index + 1) + '. ' + student.displayName + ' (' + student.studentId + ')\n';
                    report += '   ãƒ¡ãƒ¼ãƒ«: ' + student.email + '\n';
                    report += '   åˆå›å…¥å®¤: ' + student.firstJoinTime + ' | ã®ã¹åœ¨å®¤æ™‚é–“: ' + student.totalDuration + 'åˆ†\n';
                    report += '   è¦ãƒ•ã‚©ãƒ­ãƒ¼ç†ç”±: ' + reasons.join(', ') + '\n';
                    if (student.allNames.length > 1) {
                        report += '   ä½¿ç”¨ã—ãŸåå‰: ' + student.allNames.join(', ') + '\n';
                    }
                    report += '\n';
                });
            }
            
            return report;
        }

        function downloadFile(content, filename, contentType) {
            try {
                const blob = new Blob([content], { type: contentType + ';charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showMessage(filename + 'ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success' : 'warning';
            messageDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.children[2]);
            
            setTimeout(function() {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        function showLoading() {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.innerHTML = '<div class="loading"><div class="spinner"></div><p>ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­...</p></div>';
            resultsSection.style.display = 'block';
        }

        function hideLoading() {
            // Loading state is replaced by results
        }
    </script>
</body>
</html>
